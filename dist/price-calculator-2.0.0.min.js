self.addEventListener('DOMContentLoaded', function() {
  var jQuery = self.jQuery;
  var ONE_MONTH = 30.5;
  var SIZES = ['Bytes', 'KiB', 'MiB', 'GiB', 'TiB'];
  var BANNERS = [
    { name: 'small', size: 0 },
    { name: 'medium', size: 1024 * 2 },
    { name: 'large', size: 1024 * 6 },
    { name: 'x-large', size: 1024 * 10 }
  ];
  var DATA = JSON.parse('[{"key":512,"memory":"512 MiB","cpu":"500 mC","chfPerDay":"0.92 CHF","chfPer30Days":"27.60 CHF"},{"key":1024,"memory":"1.0 GiB","cpu":"700 mC","chfPerDay":"1.84 CHF","chfPer30Days":"55.20 CHF"},{"key":1536,"memory":"1.5 GiB","cpu":"900 mC","chfPerDay":"2.76 CHF","chfPer30Days":"82.80 CHF"},{"key":2048,"memory":"2.0 GiB","cpu":"1100 mC","chfPerDay":"3.68 CHF","chfPer30Days":"110.40 CHF"},{"key":2560,"memory":"2.5 GiB","cpu":"1300 mC","chfPerDay":"4.60 CHF","chfPer30Days":"138.00 CHF"},{"key":3072,"memory":"3.0 GiB","cpu":"1500 mC","chfPerDay":"5.52 CHF","chfPer30Days":"165.60 CHF"},{"key":3584,"memory":"3.5 GiB","cpu":"1700 mC","chfPerDay":"6.44 CHF","chfPer30Days":"193.20 CHF"},{"key":4096,"memory":"4.0 GiB","cpu":"1900 mC","chfPerDay":"7.36 CHF","chfPer30Days":"220.80 CHF"},{"key":4608,"memory":"4.5 GiB","cpu":"2100 mC","chfPerDay":"8.28 CHF","chfPer30Days":"248.40 CHF"},{"key":5120,"memory":"5.0 GiB","cpu":"2300 mC","chfPerDay":"9.20 CHF","chfPer30Days":"276.00 CHF"},{"key":5632,"memory":"5.5 GiB","cpu":"2500 mC","chfPerDay":"10.12 CHF","chfPer30Days":"303.60 CHF"},{"key":6144,"memory":"6.0 GiB","cpu":"2700 mC","chfPerDay":"11.04 CHF","chfPer30Days":"331.20 CHF"},{"key":6656,"memory":"6.5 GiB","cpu":"2900 mC","chfPerDay":"11.96 CHF","chfPer30Days":"358.80 CHF"},{"key":7168,"memory":"7.0 GiB","cpu":"3100 mC","chfPerDay":"12.88 CHF","chfPer30Days":"386.40 CHF"},{"key":7680,"memory":"7.5 GiB","cpu":"3300 mC","chfPerDay":"13.80 CHF","chfPer30Days":"414.00 CHF"},{"key":8192,"memory":"8.0 GiB","cpu":"3500 mC","chfPerDay":"14.72 CHF","chfPer30Days":"441.60 CHF"},{"key":8704,"memory":"8.5 GiB","cpu":"3700 mC","chfPerDay":"15.64 CHF","chfPer30Days":"469.20 CHF"},{"key":9216,"memory":"9.0 GiB","cpu":"3900 mC","chfPerDay":"16.56 CHF","chfPer30Days":"496.80 CHF"},{"key":9728,"memory":"9.5 GiB","cpu":"4100 mC","chfPerDay":"17.48 CHF","chfPer30Days":"524.40 CHF"},{"key":10240,"memory":"10.0 GiB","cpu":"4300 mC","chfPerDay":"18.40 CHF","chfPer30Days":"552.00 CHF","dedicatedNodeInfo":true},{"key":10752,"memory":"10.5 GiB","cpu":"4500 mC","chfPerDay":"19.32 CHF","chfPer30Days":"579.60 CHF","dedicatedNodeInfo":true},{"key":11264,"memory":"11.0 GiB","cpu":"4700 mC","chfPerDay":"20.24 CHF","chfPer30Days":"607.20 CHF","dedicatedNodeInfo":true},{"key":11776,"memory":"11.5 GiB","cpu":"4900 mC","chfPerDay":"21.16 CHF","chfPer30Days":"634.80 CHF","dedicatedNodeInfo":true},{"key":12288,"memory":"12.0 GiB","cpu":"5100 mC","chfPerDay":"22.08 CHF","chfPer30Days":"662.40 CHF","dedicatedNodeInfo":true},{"key":12800,"memory":"12.5 GiB","cpu":"5300 mC","chfPerDay":"23.00 CHF","chfPer30Days":"690.00 CHF","dedicatedNodeInfo":true},{"key":13312,"memory":"13.0 GiB","cpu":"5500 mC","chfPerDay":"23.92 CHF","chfPer30Days":"717.60 CHF","dedicatedNodeInfo":true},{"key":13824,"memory":"13.5 GiB","cpu":"5700 mC","chfPerDay":"24.84 CHF","chfPer30Days":"745.20 CHF","dedicatedNodeInfo":true},{"key":14336,"memory":"14.0 GiB","cpu":"5900 mC","chfPerDay":"25.76 CHF","chfPer30Days":"772.80 CHF","dedicatedNodeInfo":true},{"key":14848,"memory":"14.5 GiB","cpu":"6100 mC","chfPerDay":"26.68 CHF","chfPer30Days":"800.40 CHF","dedicatedNodeInfo":true},{"key":15360,"memory":"15.0 GiB","cpu":"6300 mC","chfPerDay":"27.60 CHF","chfPer30Days":"828.00 CHF","dedicatedNodeInfo":true},{"key":15872,"memory":"15.5 GiB","cpu":"6500 mC","chfPerDay":"28.52 CHF","chfPer30Days":"855.60 CHF","dedicatedNodeInfo":true},{"key":16384,"memory":"16.0 GiB","cpu":"6700 mC","chfPerDay":"29.44 CHF","chfPer30Days":"883.20 CHF","dedicatedNodeInfo":true},{"key":16896,"memory":"16.5 GiB","cpu":"6900 mC","chfPerDay":"30.36 CHF","chfPer30Days":"910.80 CHF","dedicatedNodeInfo":true},{"key":17408,"memory":"17.0 GiB","cpu":"7100 mC","chfPerDay":"31.28 CHF","chfPer30Days":"938.40 CHF","dedicatedNodeInfo":true},{"key":17920,"memory":"17.5 GiB","cpu":"7300 mC","chfPerDay":"32.20 CHF","chfPer30Days":"966.00 CHF","dedicatedNodeInfo":true},{"key":18432,"memory":"18.0 GiB","cpu":"7500 mC","chfPerDay":"33.12 CHF","chfPer30Days":"993.60 CHF","dedicatedNodeInfo":true},{"key":18944,"memory":"18.5 GiB","cpu":"7700 mC","chfPerDay":"34.04 CHF","chfPer30Days":"1021.20 CHF","dedicatedNodeInfo":true},{"key":19456,"memory":"19.0 GiB","cpu":"7900 mC","chfPerDay":"34.96 CHF","chfPer30Days":"1048.80 CHF","dedicatedNodeInfo":true},{"key":19968,"memory":"19.5 GiB","cpu":"8100 mC","chfPerDay":"35.88 CHF","chfPer30Days":"1076.40 CHF","dedicatedNodeInfo":true},{"key":20480,"memory":"20.0 GiB","cpu":"8300 mC","chfPerDay":"36.80 CHF","chfPer30Days":"1104.00 CHF","dedicatedNodeInfo":true}]');

  function AppuioRangeSlider(element, options) {
    this.element = element;
    this.banners = options.banners.slice();
    this.banner = options.banner;
    this.max = options.max;
    this.min = options.min;
    this.step = options.step;
    this.valueMemory = options.valueMemory;
    this.valueCpu = options.valueCpu;
    this.valuePricePerDay = options.valuePricePerDay;
    this.valuePricePerMonth = options.valuePricePerMonth;
    this.dedicatedInfo = options.dedicatedInfo;
    this.updateState = options.updateState.bind(this);
    this.oninput = this.oninput.bind(this);

    this.init();
  }

  AppuioRangeSlider.prototype.init = function init() {
    this.element.max = this.max;
    this.element.min = this.min;
    this.element.step = this.step;
    this.updateState(Number(this.element.value));
    this.banners.sort(function(a, b) {
      return b.size - a.size;
    });
    jQuery(this.element).on('input', this.oninput);
  };

  AppuioRangeSlider.prototype.oninput = function oninput(e) {
    this.updateState(Number(e.target.value));
  };

  function updateState(value) {
    var price = DATA.find(function(price) {
      return price.key === value;
    });
    var valueMem = jQuery(this.valueMemory);
    var valueCpu = jQuery(this.valueCpu);
    var valuePricePerDay = jQuery(this.valuePricePerDay);
    var valuePricePerMonth = jQuery(this.valuePricePerMonth);
    var dedicatedInfo = jQuery(this.dedicatedInfo);

    valuePricePerDay.text(price.chfPerDay);
    valuePricePerMonth.text(price.chfPer30Days);
    valueMem.text(price.memory);
    valueCpu.text(price.cpu);

    dedicatedInfo.toggle(price.dedicatedNodeInfo === true);
    updateActiveBanner.call(this, value);
  }

  function updateActiveBanner(value) {
    var banner = this.banners.find(function(banner) {
      return banner.size <= value;
    });

    if (banner === undefined) {
      return;
    }

    jQuery(this.banner + '.active').removeClass('active');
    jQuery(this.banner + '--' + banner.name).addClass('active');
  }

  var DEFAULT_OPTIONS = {
    updateState: updateState,
    min: 512,
    max: 20480,
    step: 512,
    valueMemory: '.memoryvalue',
    valueCpu: '.cpuvalue',
    valuePricePerDay: '.pricevalueperday',
    valuePricePerMonth: '.pricevaluepermonth',
    dedicatedInfo: '.offers-package-dedicated-info',
    banners: BANNERS,
    banner: '.offers-package'
  };

  function getAttributeOptions(element) {
    var $element = jQuery(element);

    return {
      valueMemory: $element.data('appuio-value-memory'),
      valueCpu: $element.data('appuio-value-cpu'),
      valuePricePerDay: $element.data('appuio-value-price-per-day'),
      valuePricePerMonth: $element.data('appuio-value-price-per-month'),
      dedicatedInfo: $element.data('appuio-dedicated-info'),
      bannerClass: $element.data('appuio-banner'),
      max: element.max,
      min: element.min,
      step: element.step
    };
  }

  jQuery.fn.appuioRangeSlider = function(options) {
    this.each(function() {
      new AppuioRangeSlider(
        this,
        jQuery.extend(
          {},
          DEFAULT_OPTIONS,
          options || {},
          getAttributeOptions(this)
        )
      );
    });
  };

  jQuery('[data-appuio-range-slider]').appuioRangeSlider();
});
